<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>åœ°éœ‡ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åœ°å›³ - ãƒ•ãƒ«æ©Ÿèƒ½ç‰ˆ</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Leaflet TimeDimension -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-timedimension@1.1.0/dist/leaflet.timedimension.control.min.css" />
<script src="https://cdn.jsdelivr.net/npm/leaflet-timedimension@1.1.0/dist/leaflet.timedimension.min.js"></script>

<!-- Chart.jsï¼ˆåœ°éœ‡æ•°ã®æ™‚ç³»åˆ—ã‚°ãƒ©ãƒ•ç”¨ï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    margin: 0;
    font-family: sans-serif;
}
#map {
    width: 100vw;
    height: 100vh;
}

/* å³ä¸Šã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« */
#ui-panel {
    position: fixed;
    top: 10px;
    left: 10px;
    z-index: 9999;
    background: rgba(255,255,255,0.9);
    border: 2px solid #333;
    padding: 10px;
    width: 220px;
    font-size: 14px;
    border-radius: 8px;
}

/* ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å‡¡ä¾‹ */
#legend {
    margin-top: 10px;
}
#legend-bar {
    height: 20px;
    background: linear-gradient(to right, red, orange, yellow, green, blue, indigo, violet);
}

/* ã‚°ãƒ©ãƒ•è¡¨ç¤º */
#graph-container {
    position: fixed;
    bottom: 0;
    width: 100vw;
    background: rgba(255,255,255,0.95);
    height: 220px;
    display: none;
    z-index: 9999;
}
</style>
</head>

<body>

<div id="map"></div>

<!-- ===================== UI ãƒ‘ãƒãƒ« ====================== -->
<div id="ui-panel">
    <b>ãƒ•ã‚£ãƒ«ã‚¿</b><br>
    â‘  ãƒã‚°ãƒ‹ãƒãƒ¥ãƒ¼ãƒ‰:
    <select id="magFilter">
        <option value="0">ã™ã¹ã¦</option>
        <option value="3">3ä»¥ä¸Š</option>
        <option value="5">5ä»¥ä¸Š</option>
        <option value="7">7ä»¥ä¸Š</option>
    </select><br><br>

    â‘¡ å†ç”Ÿé€Ÿåº¦:
    <select id="speedControl">
        <option value="500">é€Ÿã„</option>
        <option value="1500">æ™®é€š</option>
        <option value="3000">ã‚†ã£ãã‚Š</option>
    </select><br><br>

    â‘¢ è¡¨ç¤ºæœŸé–“:
    <select id="periodControl">
        <option value="1m">30æ—¥</option>
        <option value="7d">7æ—¥</option>
        <option value="1d">24æ™‚é–“</option>
        <option value="1y">1å¹´</option>
    </select><br><br>

    â‘£ åœ°å›³ãƒ†ãƒ¼ãƒ:
    <select id="themeControl">
        <option value="light">ãƒ©ã‚¤ãƒˆ</option>
        <option value="dark">ãƒ€ãƒ¼ã‚¯</option>
        <option value="sat">è¡›æ˜Ÿå†™çœŸ</option>
    </select><br><br>

    â‘¤ åœ°åŸŸã‚¸ãƒ£ãƒ³ãƒ—:
    <select id="jumpRegion">
        <option value="">ãƒ¼</option>
        <option value="japan">æ—¥æœ¬</option>
        <option value="usa">ã‚¢ãƒ¡ãƒªã‚«è¥¿æµ·å²¸</option>
        <option value="eu">ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘</option>
        <option value="sea">æ±å—ã‚¢ã‚¸ã‚¢</option>
    </select><br><br>

    â‘¥ åœ°éœ‡ãƒªã‚¹ãƒˆ:
    <button onclick="toggleGraph()">ON / OFF</button><br><br>

    â‘¦ å‡¡ä¾‹ (æ·±ã•):
    <div id="legend">
        <div id="legend-bar"></div>
        <small>æµ…ã„ â†’ æ·±ã„</small>
    </div>

    <br>

    ğŸ”§ **è¿½åŠ æ©Ÿèƒ½**<br>
    â‘ª ãƒ—ãƒ¬ãƒ¼ãƒˆå¢ƒç•Œ:
    <button id="plateToggle">ON / OFF</button><br><br>

    â‘« æ™‚ç³»åˆ—ã‚°ãƒ©ãƒ•:
    <button onclick="toggleGraph()">ON / OFF</button><br><br>

</div>

<!-- ================= ã‚°ãƒ©ãƒ•ãƒ‘ãƒãƒ« ================= -->
<div id="graph-container">
    <canvas id="eqChart"></canvas>
</div>

<script>
// ==========================================================
// â–  åœ°å›³ä½œæˆ
// ==========================================================
let map = L.map('map').setView([20, 0], 2);

// åˆæœŸã‚¿ã‚¤ãƒ«
let baseLayers = {
    "light": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
    "dark": L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png'),
    "sat": L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
        subdomains:['mt0','mt1','mt2','mt3']
    })
};
baseLayers["light"].addTo(map);

// ==========================================================
// â–  USGS åœ°éœ‡ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆ30æ—¥ï¼‰
// ==========================================================
let url = "https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_month.geojson";

let eqLayer;
fetch(url)
    .then(res => res.json())
    .then(data => setupEarthquakes(data));

function depthColor(d) {
    return `hsl(${300 - (d / 700) * 300}, 90%, 50%)`;
}

// ==========================================================
// â–  åœ°éœ‡ãƒãƒ¼ã‚«ãƒ¼ç”Ÿæˆ
// ==========================================================
function setupEarthquakes(data) {
    let features = data.features.map(f => {
        let p = f.properties;
        let c = f.geometry.coordinates;

        return {
            "type": "Feature",
            "geometry": {
                "type": "Point",
                "coordinates": [c[0], c[1]]
            },
            "properties": {
                "time": new Date(p.time),
                "mag": p.mag ?? 0,
                "depth": c[2],
                "popup": `
                    <b>${p.place}</b><br>
                    M${p.mag}<br>
                    æ·±ã•: ${c[2]} km<br>
                    ${new Date(p.time)}
                `
            }
        };
    });

    let geojson = {
        "type": "FeatureCollection",
        "features": features
    };

    // TimeDimension
    let td = new L.TimeDimension({
        period: "PT1H"
    });
    map.timeDimension = td;

    let tdLayer = L.timeDimension.layer.geoJson(L.geoJson(geojson, {
        pointToLayer: function(f, latlng) {
            return L.circleMarker(latlng, {
                radius: 2 + f.properties.mag * 2,
                fillColor: depthColor(f.properties.depth),
                color: depthColor(f.properties.depth),
                fillOpacity: 0.7
            }).bindPopup(f.properties.popup);
        },
        filter: function(f) {
            let magLimit = Number(document.getElementById("magFilter").value);
            return f.properties.mag >= magLimit;
        }
    }), {
        updateTimeDimension: true,
        duration: "P1D"
    });

    tdLayer.addTo(map);

    eqLayer = tdLayer;
}

// ==========================================================
// â–  UI æ©Ÿèƒ½
// ==========================================================

document.getElementById("magFilter").addEventListener("change", () => {
    location.reload();
});

// åœ°å›³ãƒ†ãƒ¼ãƒåˆ‡æ›¿
document.getElementById("themeControl").addEventListener("change", e => {
    let val = e.target.value;
    baseLayers[val].addTo(map);
});

// åœ°åŸŸã‚¸ãƒ£ãƒ³ãƒ—
document.getElementById("jumpRegion").addEventListener("change", e => {
    let v = e.target.value;
    if (v === "japan") map.setView([36, 137], 4);
    if (v === "usa") map.setView([37, -120], 4);
    if (v === "eu") map.setView([50, 10], 4);
    if (v === "sea") map.setView([5, 110], 4);
});

// ==========================================================
// â–  ãƒ—ãƒ¬ãƒ¼ãƒˆå¢ƒç•Œï¼ˆON/OFFï¼‰
// ==========================================================
let plateLayer;
document.getElementById("plateToggle").onclick = () => {
    if (!plateLayer) {
        fetch("https://raw.githubusercontent.com/fraxen/tectonicplates/master/GeoJSON/PB2002_boundaries.json")
        .then(r => r.json())
        .then(b => {
            plateLayer = L.geoJSON(b, {
                style: { color: "yellow", weight: 2 }
            }).addTo(map);
        });
    } else {
        if (map.hasLayer(plateLayer)) map.removeLayer(plateLayer);
        else plateLayer.addTo(map);
    }
};

// ==========================================================
// â–  åœ°éœ‡æ•°ã‚°ãƒ©ãƒ•ï¼ˆON/OFFï¼‰
// ==========================================================
let graphOn = false;
let chart;

function toggleGraph() {
    let g = document.getElementById("graph-container");
    graphOn = !graphOn;
    g.style.display = graphOn ? "block" : "none";

    if (graphOn) loadGraph();
}

function loadGraph() {
    fetch(url)
        .then(res => res.json())
        .then(data => {
            let counts = {};

            data.features.forEach(f => {
                let t = new Date(f.properties.time).toISOString().slice(0, 10);
                counts[t] = (counts[t] || 0) + 1;
            });

            let labels = Object.keys(counts);
            let values = Object.values(counts);

            let ctx = document.getElementById("eqChart");

            if (chart) chart.destroy();

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: "åœ°éœ‡æ•°",
                        data: values
                    }]
                }
            });
        });
}
</script>
</body>
</html>
