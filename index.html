import pandas as pd
import json

# ============================
# 1. USGS 30日・M3.0+
# ============================
url = "https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/2.5_month.csv"
df = pd.read_csv(url)

df = df[df["mag"] >= 3.0].copy()

df["time"] = pd.to_datetime(df["time"])
df["lat"] = df["latitude"]
df["lon"] = df["longitude"]
df["depth"] = df["depth"].fillna(0)
df["mag"] = df["mag"].fillna(0)

# 6時間に丸め（TimeDimension用）
df["time_6h"] = df["time"].dt.floor("6H")

# ============================
# 2. 深さ → 色
# ============================
def depth_color(d):
    if d < 70:
        return "#ff0000"  # 浅い
    elif d < 300:
        return "#ffaa00"  # 中間
    else:
        return "#0000ff"  # 深い

df["color"] = df["depth"].apply(depth_color)

# マーカーサイズ
df["radius"] = df["mag"].apply(lambda m: 3 + m * 2)

# ============================
# 3. GeoJSON 化
# ============================
features = []

for _, r in df.iterrows():
    features.append({
        "type": "Feature",
        "geometry": {
            "type": "Point",
            "coordinates": [r["lon"], r["lat"]],
        },
        "properties": {
            "times": [r["time_6h"].isoformat()],
            "style": {
                "color": r["color"],
                "fillColor": r["color"],
                "fillOpacity": 0.7,
                "radius": r["radius"]
            },
            "mag": float(r["mag"]),
            "depth": float(r["depth"])
        }
    })

eq_json = {
    "type": "FeatureCollection",
    "features": features
}

# JSON を文字列に
eq_json_str = json.dumps(eq_json)

# ============================
# 4. HTML 読み込み → 埋め込み → 保存
# ============================
with open("template.html", "r", encoding="utf-8") as f:
    html = f.read()

html = html.replace("__EQ_JSON__", eq_json_str)

with open("eq_final.html", "w", encoding="utf-8") as f:
    f.write(html)

print("完成: eq_final.html")
