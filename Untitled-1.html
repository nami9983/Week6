<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>世界の地震アニメーション（6時間ごと）</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- TimeDimension -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-timedimension/dist/leaflet.timedimension.control.min.css" />
<script src="https://cdn.jsdelivr.net/npm/leaflet-timedimension/dist/leaflet.timedimension.min.js"></script>

<!-- jQuery（地震リスト用） -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<style>
  html, body { height: 100%; margin: 0; }
  #map { width: 70%; height: 100%; float: left; }
  #list { width: 30%; height: 100%; float: left; overflow-y: scroll; border-left: 2px solid #ccc; padding: 10px; }

  /* TimeDimension UI を最前面へ */
  .leaflet-control-timecontrol {
      z-index: 2000 !important;
  }

  table { width: 100%; border-collapse: collapse; }
  th, td { padding: 6px; border-bottom: 1px solid #aaa; }
  th { background: #eee; }
</style>

</head>
<body>

<div id="map"></div>
<div id="list">
  <h2>地震リスト（30日・M3+）</h2>
  <table id="eqTable">
    <thead>
      <tr><th>日時(JST)</th><th>M</th><th>深さkm</th><th>場所</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
// ==========================
// ① データ取得（USGS）
// ==========================
const url = "https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/4.5_month.geojson";

fetch(url)
  .then(res => res.json())
  .then(data => initMap(data));

// ==========================
// ② 地図を作成
// ==========================
function initMap(geojson) {

  const map = L.map('map', {
      zoom: 2,
      center: [20, 0],
      timeDimension: true,
      timeDimensionOptions: {
          period: "PT6H"
      }
  });

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  // 再生コントローラー
  const timeControl = new L.Control.TimeDimension({
      position: "bottomleft",
      autoPlay: true,
      loopButton: true,
      speedSlider: true
  });

  map.addControl(timeControl);

  // ==========================
  // ③ マーカーの色とサイズ
  // ==========================
  function getColor(depth) {
      if (depth < 70) return "red";
      if (depth < 300) return "yellow";
      return "blue";
  }

  function style(feature) {
      return {
          radius: 4 + feature.properties.mag * 2,
          color: getColor(feature.geometry.coordinates[2]),
          fillColor: getColor(feature.geometry.coordinates[2]),
          fillOpacity: 0.6
      };
  }

  // ==========================
  // ④ GeoJSON → TimeDimensionLayer
  // ==========================
  const geoLayer = L.geoJson(geojson, {
      pointToLayer: function(feature, latlng) {
          return L.circleMarker(latlng, style(feature));
      },
      onEachFeature: function(feature, layer) {

          // 日本時間へ
          const jst = new Date(feature.properties.time + 9 * 3600 * 1000);
          const jstStr = jst.toISOString().replace("T", " ").slice(0, 19);

          const depth = feature.geometry.coordinates[2];
          const mag = feature.properties.mag;
          const place = feature.properties.place;

          // ポップアップ
          layer.bindPopup(
              `<b>${place}</b><br>
              日時(JST): ${jstStr}<br>
              M: ${mag}<br>
              深さ: ${depth} km`
          );

          // リストへ追加
          addTableRow(jstStr, mag, depth, place, layer);
      }
  });

  const tdLayer = L.timeDimension.layer.geoJson(geoLayer, {
      updateTimeDimension: true,
      addlastPoint: false
  });

  tdLayer.addTo(map);
}

// ==========================
// ⑤ 地震リストを作成
// ==========================
function addTableRow(jst, mag, depth, place, layer) {
    const row = `
      <tr class="rowItem">
          <td>${jst}</td>
          <td>${mag}</td>
          <td>${depth}</td>
          <td>${place}</td>
      </tr>
    `;

    $("#eqTable tbody").append(row);

    // 行をクリック → 該当地点へ飛ぶ
    $("#eqTable tbody tr:last").on("click", function() {
        layer.openPopup();
    });
}

</script>

</body>
</html>
