<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>世界の地震アニメーション（6時間ごと）</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- TimeDimension -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-timedimension/dist/leaflet.timedimension.control.min.css" />
<script src="https://cdn.jsdelivr.net/npm/leaflet-timedimension/dist/leaflet.timedimension.min.js"></script>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<style>
  html, body {
      height: 100%;
      margin: 0;
  }
  #map {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0; left: 0;
  }

  /* リストを右上パネルに */
  #list {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 340px;
      max-height: 70%;
      background: rgba(255,255,255,0.9);
      border-radius: 8px;
      padding: 10px;
      overflow-y: auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      z-index: 2000;
  }

  table { width: 100%; border-collapse: collapse; }
  th, td { padding: 6px; border-bottom: 1px solid #aaa; }
  th { background: #eee; }

  /* TimeDimension UI を最前面 */
  .leaflet-control-timecontrol {
      z-index: 3000 !important;
  }
</style>

</head>
<body>

<div id="map"></div>

<!-- 右上パネル -->
<div id="list">
  <h3>地震リスト（30日・M3+）</h3>
  <table id="eqTable">
    <thead>
      <tr><th>日時(JST)</th><th>M</th><th>深さ</th><th>場所</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>

// ========== ① USGS データ ==========
const url = "https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/4.5_month.geojson";

fetch(url)
  .then(res => res.json())
  .then(data => initMap(data));


// ========== ② 地図 ==========
function initMap(geojson) {

  const map = L.map('map', {
      zoom: 2,
      center: [20, 0],
      timeDimension: true,
      timeDimensionOptions: {
          period: "PT6H"
      }
  });

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  const timeControl = new L.Control.TimeDimension({
      position: "bottomleft",
      autoPlay: true,
      loopButton: true,
      speedSlider: true
  });

  map.addControl(timeControl);


  // 色分け
  function getColor(depth) {
      if (depth < 70) return "red";
      if (depth < 300) return "yellow";
      return "blue";
  }

  function style(feature) {
      const depth = feature.geometry.coordinates[2];
      return {
          radius: 4 + feature.properties.mag * 2,
          color: getColor(depth),
          fillColor: getColor(depth),
          fillOpacity: 0.6
      };
  }


  // ========== ③ マーカー & リスト作成 ==========
  const geoLayer = L.geoJson(geojson, {
      pointToLayer: function(feature, latlng) {
          return L.circleMarker(latlng, style(feature));
      },
      onEachFeature: function(feature, layer) {

          const depth = feature.geometry.coordinates[2];
          const mag = feature.properties.mag;
          const place = feature.properties.place;

          // 日本時間
          const jst = new Date(feature.properties.time + 9 * 3600 * 1000);
          const jstStr = jst.toISOString().replace("T"," ").substring(0,19);

          layer.bindPopup(
              `<b>${place}</b><br>
              JST: ${jstStr}<br>
              M: ${mag}<br>
              深さ: ${depth} km`
          );

          addRow(jstStr, mag, depth, place, layer);
      }
  });

  const tdLayer = L.timeDimension.layer.geoJson(geoLayer, {
      updateTimeDimension: true,
      addlastPoint: false
  });

  tdLayer.addTo(map);
}


// ========== ④ リストへ追加 ==========
function addRow(jst, mag, depth, place, layer) {

    const row = `
      <tr>
        <td>${jst}</td>
        <td>${mag}</td>
        <td>${depth}</td>
        <td>${place}</td>
      </tr>
    `;

    $("#eqTable tbody").append(row);

    // クリックでジャンプ
    $("#eqTable tbody tr:last").on("click", function () {
        layer.openPopup();
    });
}

</script>

</body>
</html>
